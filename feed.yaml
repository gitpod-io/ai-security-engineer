name: "[Jonas] Fetch Vulnerability Feeds"
description: Monitors public CVE feeds for vulnerabilities affecting our tech stack (Go, TypeScript, JavaScript, Kotlin, Java, Ubuntu, Debian, AWS, GCP) and creates Linear issues for awareness

triggers:
  - manual: {}
    context:
      projects: {}

action:
  limits:
    maxParallel: 1
    maxTotal: 10
  steps:
    - task:
        command: |
          set -e

          # Calculate date range (last 2 days)
          END_DATE=$(date -u +%Y-%m-%dT%H:%M:%S.000)
          START_DATE=$(date -u -d "2 days ago" +%Y-%m-%dT%H:%M:%S.000)

          echo "Fetching CVEs published between $START_DATE and $END_DATE"

          # Fetch from NVD API (National Vulnerability Database)
          # NVD API docs: https://nvd.nist.gov/developers/vulnerabilities
          curl -s "https://services.nvd.nist.gov/rest/json/cves/2.0?pubStartDate=${START_DATE}&pubEndDate=${END_DATE}&resultsPerPage=2000" \
            -H "Accept: application/json" \
            -o /tmp/nvd-cves.json

          # Fetch from OSV (Open Source Vulnerabilities) for ecosystem-specific data
          # Query for each ecosystem we care about
          for ecosystem in "Go" "npm" "Maven" "PyPI"; do
            echo "Fetching OSV data for $ecosystem..."
            curl -s "https://api.osv.dev/v1/query" \
              -X POST \
              -H "Content-Type: application/json" \
              -d "{\"package\": {\"ecosystem\": \"$ecosystem\"}}" \
              -o "/tmp/osv-${ecosystem}.json" || true
          done

          # Fetch GitHub Security Advisories (public feed)
          curl -s "https://api.github.com/advisories?per_page=100&sort=published&direction=desc" \
            -H "Accept: application/vnd.github+json" \
            -o /tmp/github-advisories.json || true

          # Fetch CISA Known Exploited Vulnerabilities (KEV) catalog
          # These are actively exploited in the wild - highest priority
          echo "Fetching CISA KEV catalog..."
          curl -s "https://www.cisa.gov/sites/default/files/feeds/known_exploited_vulnerabilities.json" \
            -o /tmp/cisa-kev.json || true

          # Fetch AWS Security Bulletins RSS
          echo "Fetching AWS Security Bulletins..."
          curl -s "https://aws.amazon.com/security/security-bulletins/feed/" \
            -o /tmp/aws-security.xml || true

          # Fetch GCP Security Bulletins
          echo "Fetching GCP Security Bulletins..."
          curl -s "https://cloud.google.com/feeds/google-cloud-security-bulletins.xml" \
            -o /tmp/gcp-security.xml || true

          echo "CVE data fetched successfully"
          echo "NVD results: $(cat /tmp/nvd-cves.json | head -c 500)"

    - agent:
        prompt: |
          Create Linear issues for new vulnerabilities affecting our stack.

          FEEDS (already fetched):
          - /tmp/nvd-cves.json, /tmp/osv-*.json, /tmp/github-advisories.json
          - /tmp/cisa-kev.json (actively exploited - always include)
          - /tmp/aws-security.xml, /tmp/gcp-security.xml

          FILTER TO:
          - Stack: Go, TypeScript, JavaScript, Kotlin, Java, Ubuntu, Debian, AWS, GCP
          - Severity: HIGH/CRITICAL (CVSS >= 7.0) or CISA KEV
          - Published: last 2 days

          FOR EACH VULNERABILITY:
          1. Search Linear team "Ona AI Security Engineer" for existing issue with advisory ID
          2. If not found, create issue with:
             - Title: "[Advisory] <ID>: Brief description" (ID = CVE, GHSA, USN, DSA, GO-, or vendor ID)
             - Labels: ["advisory"]

          ISSUE DESCRIPTION FORMAT:
          ```
          > **This is a vulnerability ADVISORY, not a finding. Review to determine if your codebase is affected.**

          ## Why This Was Flagged
          - [Reason: e.g., "CVSS 9.8 CRITICAL", "CISA KEV (actively exploited)", "Affects Go ecosystem"]

          ## Vulnerability Summary
          - **Advisory ID:** CVE-XXXX-XXXXX / GHSA-XXXX / USN-XXXX / GO-XXXX-XXXX (use available ID)
          - **Published:** YYYY-MM-DD
          - **CVSS Score:** X.X (CRITICAL/HIGH/MEDIUM) or "Not scored"
          - **CISA KEV:** Yes/No
          - **Source:** NVD / GitHub / OSV / CISA KEV / AWS / GCP

          ## Affected Components
          - **Ecosystem:** Go / npm / Maven / OS / Cloud
          - **Package(s):** package-name
          - **Vulnerable Versions:** < X.Y.Z
          - **Fixed Version:** X.Y.Z (if available)

          ## Technical Details
          [Description of the vulnerability and potential impact]

          ## Detection Guidance
          1. Search for imports/dependencies on: `package-name`
          2. Check version in: go.mod / package.json / pom.xml / build.gradle
          3. Vulnerable if version matches: < X.Y.Z

          ## Remediation
          - Upgrade to version X.Y.Z or later
          - Workaround: [if available]

          ## References
          - [Link to source advisory]
          ```

          Report count of new advisories created.

    - agent:
        prompt: |
          Close advisory issues that are old or now detectable by scanners.

          1. List issues in Linear team "Ona AI Security Engineer" with label "advisory"

          2. For each advisory, check if it should be closed:
             a. **Age check:** Created more than 7 days ago
             b. **Scanner coverage check:** Query Trivy and OSV databases to see if they now include this vulnerability:
                - Run: trivy image --download-db-only (ensures fresh DB)
                - Run: trivy sbom --list-all-pkgs /dev/null 2>&1 | grep -i "<CVE-ID>" or check OSV API
                - If the CVE/advisory ID appears in scanner databases, it's now detectable

          3. Close the issue if EITHER condition is met:
             - If closing due to age:
               Comment: "Auto-closing: advisory is over 7 days old. Reopen if still relevant."
             - If closing due to scanner coverage:
               Comment: "Auto-closing: this vulnerability is now detectable by Trivy/OSV-Scanner. Future occurrences will be caught by repository scans."

          4. Report count of closed advisories and reason breakdown

    - report:
        outputs:
          - key: total_cves_fetched
            title: Total CVEs Fetched
            string: {}
            prompt: |
              Count the total number of CVEs retrieved from all feeds before filtering.
              Return ONLY the integer count, nothing else.
          - key: relevant_cves
            title: Relevant CVEs (matching tech stack)
            string: {}
            prompt: |
              Count the number of CVEs that matched our target tech stack filter.
              Return ONLY the integer count, nothing else.
          - key: advisories_created
            title: Linear Advisories Created
            string: {}
            prompt: |
              Count how many new Linear advisory issues were created.
              Return ONLY the integer count, nothing else.
          - key: cve_ids
            title: CVE IDs Processed
            string: {}
            prompt: |
              List all CVE IDs that were processed and created as advisories.
              Return ONLY a comma-separated list of CVE IDs, or "none" if no advisories created.
